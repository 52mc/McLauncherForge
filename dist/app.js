"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function buildUrl(e){return""+forgeUrl+e}function obj2jsonstr(e){return JSON.stringify(e,null,"\t")}function analyseAndWriteToFile(e){return new _bluebird.Promise(function(r,t){_log2["default"].debug("开始分析forge页面，version: "+e.version),_io2["default"].request(buildUrl(e.url),2e4).then(function(e){var r=(0,_parse2["default"])(e);return r.getForgeVersion()}).then(function(r){return _io2["default"].createFolderAndWriteFile(_path2["default"].resolve(outputFolder,"forge/"+e.version+".json"),JSON.stringify(r,null,"\t"))}).then(function(){return r()})["catch"](function(e){return t(e)})})}require("babel-polyfill");var _path=require("path"),_path2=_interopRequireDefault(_path),_bluebird=require("bluebird"),_io=require("./lib/io"),_io2=_interopRequireDefault(_io),_parse=require("./lib/parse"),_parse2=_interopRequireDefault(_parse),_log=require("./lib/log"),_log2=_interopRequireDefault(_log),forgeUrl="http://files.minecraftforge.net/",outputFolder=_path2["default"].resolve(__dirname,"..","files");_log2["default"].debug("开始分析任务..."),_io2["default"].request(forgeUrl,2e4).then(function(e){var r=(0,_parse2["default"])(e),t=r.getSupportVersion();return{parser:r,vs:t}}).then(function(e){for(var r=(e.parser.getForgeVersion(),{}),t=0;t<e.vs.length;t++)for(var n=e.vs[t],u=0;u<n.subs.length;u++){var o=n.subs[u];r[o.version]=o}return{forgeMap:r,vs:e.vs}}).then(function(e){var r=e.forgeMap,t=Reflect.ownKeys(r),n=t.length-1,u=(0,_bluebird.coroutine)(regeneratorRuntime.mark(function o(){var u,i,l=this;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:_log2["default"].debug("准备分析页面，共有"+n+"个任务."),u=regeneratorRuntime.mark(function a(){var e;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return e=r[t[i]],u.next=3,analyseAndWriteToFile(e).then(function(){_log2["default"].debug("分析完毕，forge "+e.version+".json 写入成功！")})["catch"](function(e){_log2["default"].error("分析forge页面失败。",e),i--,_log2["default"].debug("开始一次重试...")})["finally"](function(){_log2["default"].debug("[========== 剩余任务数："+(n-i)+" ==========]\n\n")});case 3:case"end":return u.stop()}},a,l)}),i=0;case 3:if(!(i<=n)){o.next=8;break}return o.delegateYield(u(),"t0",5);case 5:i++,o.next=3;break;case 8:return o.abrupt("return",e.vs);case 9:case"end":return o.stop()}},o,this)}));return u()}).then(function(e){return _io2["default"].createFolderAndWriteFile(_path2["default"].resolve(outputFolder,"versions.json"),obj2jsonstr(e))}).then(function(){_log2["default"].debug("versions.json 写入成功！"),_log2["default"].debug("分析任务全部完毕，文件已全部写出到files目录下，请查看。")})["catch"](function(e){_log2["default"].error("error",e)});